<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>Operations Dashboard</title>

<!-- MSAL library -->
<script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>

/* ===== Script 1 ===== */
<script>
/* ===== Debug toggle (Part 1) ===== */
const DEBUG_P1 = true;
const d1 = (...args) => { if (DEBUG_P1) console.log("[P1]", ...args); };

/* ===== MSAL + Graph Config ===== */
const loginScopes = ["openid", "profile", "User.Read"];
const graphScopes = ["Sites.ReadWrite.All"];

const msalConfig = {
  auth: {
    clientId: "ec19d272-57da-4130-b8a7-68500bcb0ac6",
    authority: "https://login.microsoftonline.com/2f061df2-aea0-4206-9047-e0b42ffd47b4",
    redirectUri: "https://jlark1.github.io/OperationsDashboard/"
  },
  cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false },
  system: { allowNativeBroker: false, navigateToLoginRequestUrl: false }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);

/* ===== Login & Token ===== */
async function ensureLogin() {
  let account = msalInstance.getAllAccounts()[0];
  d1("ensureLogin: existing account?", !!account);
  if (!account) {
    d1("ensureLogin: prompting loginPopup");
    const resp = await msalInstance.loginPopup({ scopes: loginScopes, prompt: "select_account" });
    msalInstance.setActiveAccount(resp.account);
    account = resp.account;
  }
  d1("ensureLogin: active account", account?.username);
  return account;
}
async function getToken() {
  const account = await ensureLogin();
  try {
    d1("getToken: acquireTokenSilent");
    const r = await msalInstance.acquireTokenSilent({ scopes: graphScopes, account });
    d1("getToken: success (silent)");
    return r.accessToken;
  } catch (e) {
    d1("getToken: silent failed, falling back to popup", e);
    const r = await msalInstance.acquireTokenPopup({ scopes: graphScopes, account });
    d1("getToken: success (popup)");
    return r.accessToken;
  }
}

/* ===== SharePoint IDs ===== */
const siteId = "associatedeyecareazure.sharepoint.com,f7f8c2bf-c387-440c-8d96-1373fb6e8517,adcaee90-7252-4f40-86f1-3d8c0dc8b216";
const podsListId = "b4cf5247-2062-4440-8fb5-338f2a09cc1c";
const testsListId = "369707df-a571-4ba6-a04b-1aea8b3ef66f";
const notesListId = "771054d8-ecc7-40e8-ab57-9488af13e727";
const staffingListId = "204e2f8f-afb9-4f0b-98be-90e18c5a4308";
const pfcListId = "a7786d2e-f0f1-499f-90e18c5a927ebf".replace("927","d9b"); // safety guard if pasted; will be corrected below
// Correct pfcListId (keep final value exactly as provided originally)
const _pfcFix = "a7786d2e-f0f1-499f-90e4-df668b927ebf"; 
const patientCountListId = "d151ffc1-5d78-4aec-8689-5f558f7d9b20";
const equipListId = "a72e0d60-faca-4421-b137-b0f537745ccc";
const buildListId = "14dee9e3-b932-472e-a93f-b7da9abb9ad3";
const PFC_LIST_ID = _pfcFix;

/* ===== Generic Save Helpers (used by simple cases) ===== */
async function doSave(listId, item) {
  try {
    const token = await getToken();
    const url = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items`;
    d1("doSave: POST", { listId, url, item });
    const res = await fetch(url, {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
      body: JSON.stringify(item)
    });
    if (!res.ok) {
      const t = await res.text();
      console.error("[SP] Save failed:", res.status, t);
      return null;
    } else {
      const data = await res.json();
      d1("doSave: OK", data?.id);
      return data;
    }
  } catch (err) {
    console.error("[SP] Save failed:", err);
    return null;
  }
}
async function saveToList(listId, title, dataObj) {
  const item = {
    fields: {
      Title: title,
      Location: state.location,
      Date: state.date,
      DataJson: JSON.stringify(dataObj)
    }
  };
  return doSave(listId, item);
}
async function saveToListNoDate(listId, title, dataObj) {
  const item = {
    fields: {
      Title: title,
      Location: state.location,
      DataJson: JSON.stringify(dataObj)
    }
  };
  return doSave(listId, item);
}
async function saveSimpleToList(listId, title, fieldName, value) {
  const item = { fields: { Title: title } };
  item.fields[fieldName] = value;
  return doSave(listId, item);
}

/* ===== Upsert Helpers (filter builder) ===== */
function buildFilterLocationDate(loc, day) {
  // Encode the whole filter string for safety
  return encodeURIComponent(`fields/Location eq '${loc}' and fields/Date eq '${day}'`);
}

/* ===== Pods Save (Upsert by Location + Date) ===== */
async function savePodsToSharePoint(d) {
  try {
    const token = await getToken();
    const loc = state.location;
    const day = state.date;
    const filter = buildFilterLocationDate(loc, day);
    const findUrl =
      `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${podsListId}/items?` +
      `$expand=fields&$filter=${filter}&$top=1`;
    d1("Pods: lookup", findUrl);

    const findRes = await fetch(findUrl, { headers: { Authorization: `Bearer ${token}` } });
    if (!findRes.ok) {
      console.error("[SP] Pods lookup failed:", findRes.status, await findRes.text());
      return;
    }
    const findJson = await findRes.json();
    const existing = (findJson.value && findJson.value.length > 0) ? findJson.value[0] : null;

    const fields = {
      Title: `${loc} ${day} - Pods`,
      Location: loc,
      Date: day,
      DataJson: JSON.stringify(d.pods)
    };

    if (existing) {
      const updateUrl = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${podsListId}/items/${existing.id}/fields`;
      d1("Pods: update", updateUrl, fields);
      const updateRes = await fetch(updateUrl, {
        method: "PATCH",
        headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json", "If-Match": "*" },
        body: JSON.stringify(fields)
      });
      if (!updateRes.ok) {
        console.error("[SP] Pods update failed:", updateRes.status, await updateRes.text());
      } else {
        d1("Pods: updated", existing.id);
      }
    } else {
      const createUrl = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${podsListId}/items`;
      const payload = { fields };
      d1("Pods: create", createUrl, payload);
      const createRes = await fetch(createUrl, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!createRes.ok) {
        console.error("[SP] Pods create failed:", createRes.status, await createRes.text());
      } else {
        const data = await createRes.json();
        d1("Pods: created", data?.id);
      }
    }
  } catch (err) {
    console.error("[SP] Pods save threw error:", err);
  }
}

/* ===== Special Testing Save (Upsert by Location + Date) ===== */
async function saveTestsToSharePoint(d) {
  try {
    const token = await getToken();
    const loc = state.location;
    const day = state.date;
    const filter = buildFilterLocationDate(loc, day);
    const findUrl =
      `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${testsListId}/items?` +
      `$expand=fields&$filter=${filter}&$top=1`;
    d1("Tests: lookup", findUrl);

    const findRes = await fetch(findUrl, { headers: { Authorization: `Bearer ${token}` } });
    if (!findRes.ok) {
      console.error("[SP] Tests lookup failed:", findRes.status, await findRes.text());
      return;
    }
    const found = await findRes.json();
    const existing = (found.value && found.value.length > 0) ? found.value[0] : null;

    const fields = {
      Title: `${loc} ${day} - Tests`,
      Location: loc,
      Date: day,
      DataJson: JSON.stringify(d.tests || [])
    };

    if (existing) {
      const url = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${testsListId}/items/${existing.id}/fields`;
      d1("Tests: update", url, fields);
      const res = await fetch(url, {
        method: "PATCH",
        headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json", "If-Match": "*" },
        body: JSON.stringify(fields)
      });
      if (!res.ok) console.error("[SP] Tests update failed:", res.status, await res.text());
      else d1("Tests: updated", existing.id);
    } else {
      const url = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${testsListId}/items`;
      const payload = { fields };
      d1("Tests: create", url, payload);
      const res = await fetch(url, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) console.error("[SP] Tests create failed:", res.status, await res.text());
      else {
        const data = await res.json();
        d1("Tests: created", data?.id);
      }
    }
  } catch (e) {
    console.error("[SP] Tests save threw:", e);
  }
}

/* ===== Important Information/Overbooks Save (Upsert by Location + Date) ===== */
async function saveNotesToSharePoint(d) {
  try {
    const token = await getToken();
    const loc = state.location;
    const day = state.date;
    const filter = buildFilterLocationDate(loc, day);
    const findUrl =
      `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${notesListId}/items?` +
      `$expand=fields&$filter=${filter}&$top=1`;
    d1("Notes: lookup", findUrl);

    const findRes = await fetch(findUrl, { headers: { Authorization: `Bearer ${token}` } });
    if (!findRes.ok) {
      console.error("[SP] Notes lookup failed:", findRes.status, await findRes.text());
      return;
    }
    const found = await findRes.json();
    const existing = (found.value && found.value.length > 0) ? found.value[0] : null;

    const fields = {
      Title: `${loc} ${day} - Notes`,
      Location: loc,
      Date: day,
      DataJson: JSON.stringify(d.notes || "")
    };

    if (existing) {
      const url = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${notesListId}/items/${existing.id}/fields`;
      d1("Notes: update", url, fields);
      const res = await fetch(url, {
        method: "PATCH",
        headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json", "If-Match": "*" },
        body: JSON.stringify(fields)
      });
      if (!res.ok) console.error("[SP] Notes update failed:", res.status, await res.text());
      else d1("Notes: updated", existing.id);
    } else {
      const url = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${notesListId}/items`;
      const payload = { fields };
      d1("Notes: create", url, payload);
      const res = await fetch(url, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) console.error("[SP] Notes create failed:", res.status, await res.text());
      else {
        const data = await res.json();
        d1("Notes: created", data?.id);
      }
    }
  } catch (e) {
    console.error("[SP] Notes save threw:", e);
  }
}

/* ===== Staffing Impacts Save (Upsert by Location + Date) ===== */
async function saveStaffingToSharePoint(d) {
  try {
    const token = await getToken();
    const loc = state.location;
    const day = state.date;
    const filter = buildFilterLocationDate(loc, day);
    const findUrl =
      `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${staffingListId}/items?` +
      `$expand=fields&$filter=${filter}&$top=1`;
    d1("Staffing: lookup", findUrl);

    const findRes = await fetch(findUrl, { headers: { Authorization: `Bearer ${token}` } });
    if (!findRes.ok) {
      console.error("[SP] Staffing lookup failed:", findRes.status, await findRes.text());
      return;
    }
    const found = await findRes.json();
    const existing = (found.value && found.value.length > 0) ? found.value[0] : null;

    const fields = {
      Title: `${loc} ${day} - Staffing`,
      Location: loc,
      Date: day,
      DataJson: JSON.stringify(d.staffing || "")
    };

    if (existing) {
      const url = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${staffingListId}/items/${existing.id}/fields`;
      d1("Staffing: update", url, fields);
      const res = await fetch(url, {
        method: "PATCH",
        headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json", "If-Match": "*" },
        body: JSON.stringify(fields)
      });
      if (!res.ok) console.error("[SP] Staffing update failed:", res.status, await res.text());
      else d1("Staffing: updated", existing.id);
    } else {
      const url = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${staffingListId}/items`;
      const payload = { fields };
      d1("Staffing: create", url, payload);
      const res = await fetch(url, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) console.error("[SP] Staffing create failed:", res.status, await res.text());
      else {
        const data = await res.json();
        d1("Staffing: created", data?.id);
      }
    }
  } catch (e) {
    console.error("[SP] Staffing save threw:", e);
  }
}

/* ===== PFC & Patient Count (simple posts) ===== */
async function savePfcToSharePoint(d) {
  d1("PFC: saving", d.pfc);
  await saveSimpleToList(PFC_LIST_ID, `${state.location} ${state.date} - PFC`, "PFC", d.pfc);
}
async function savePatientCountToSharePoint(d) {
  d1("PatientCount: saving", d.todayCount);
  await saveSimpleToList(patientCountListId, `${state.location} ${state.date} - PatientCount`, "Count", d.todayCount);
}

/* ===== Save Equipment (no Date) ===== */
async function saveEquipToSharePoint(d) {
  try {
    const token = await getToken();
    const loc = state.location;

    const payload = {
      fields: {
        Title: `${loc} - Equipment`,
        Location: loc,
        DataJson: JSON.stringify(d.equipment || [])
      }
    };

    // Find existing equipment item for this location
    const findUrl =
      `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${equipListId}/items?` +
      `$select=id&$expand=fields($select=Location)&$filter=fields/Location eq '${loc}'&$top=1`;

    const findRes = await fetch(findUrl, { headers: { Authorization: `Bearer ${token}` } });

    let method = "POST";
    let target = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${equipListId}/items`;

    if (findRes.ok) {
      const found = await findRes.json();
      if (found.value && found.value.length) {
        method = "PATCH";
        target = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${equipListId}/items/${found.value[0].id}/fields`;
      }
    }

    const res = await fetch(target, {
      method,
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: method === "PATCH" ? JSON.stringify(payload.fields) : JSON.stringify(payload)
    });

    if (!res.ok) {
      console.error("[SP] Equip save failed:", res.status, await res.text());
    } else {
      d2("Equip saved to SharePoint for", loc);
    }
  } catch (err) {
    console.error("[SP] Equip save threw error:", err);
  }
}

/* ===== Save Building (no Date) ===== */
async function saveBuildToSharePoint(d) {
  try {
    const token = await getToken();
    const loc = state.location;

    const payload = {
      fields: {
        Title: `${loc} - Building`,
        Location: loc,
        DataJson: JSON.stringify(d.building || [])
      }
    };

    // Find existing building item for this location
    const findUrl =
      `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${buildListId}/items?` +
      `$select=id&$expand=fields($select=Location)&$filter=fields/Location eq '${loc}'&$top=1`;

    const findRes = await fetch(findUrl, { headers: { Authorization: `Bearer ${token}` } });

    let method = "POST";
    let target = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${buildListId}/items`;

    if (findRes.ok) {
      const found = await findRes.json();
      if (found.value && found.value.length) {
        method = "PATCH";
        target = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${buildListId}/items/${found.value[0].id}/fields`;
      }
    }

    const res = await fetch(target, {
      method,
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: method === "PATCH" ? JSON.stringify(payload.fields) : JSON.stringify(payload)
    });

    if (!res.ok) {
      console.error("[SP] Build save failed:", res.status, await res.text());
    } else {
      d2("Build saved to SharePoint for", loc);
    }
  } catch (err) {
    console.error("[SP] Build save threw error:", err);
  }
}

</script>

<style>
:root{
  --bg:#0d1b2a; --ink:#e6edf7; --card:#fff; --card-ink:#14213d;
  --primary:#0c4da2; --border:#dbe3f8; --gap:10px;
  --shadow:0 4px 12px rgba(0,0,0,.15),0 1px 3px rgba(0,0,0,.12);
}
body{margin:0;padding:12px;background:var(--bg);font:13px Segoe UI,Arial;color:var(--ink);height:100vh;display:flex;flex-direction:column;overflow:hidden}
h1{margin:0 0 8px;font-size:20px;color:#fff}
.topbar{display:grid;grid-template-columns:1fr auto 1.2fr;gap:var(--gap);margin-bottom:12px;align-items:center;}
.mini-card{background:#0f2238;border:1px solid #2a3b52;border-radius:10px;padding:6px 10px;color:#eaf1ff;display:flex;gap:12px}
.mini-card div{display:flex;flex-direction:column}
.mini-card label{font-size:11px;font-weight:600}
.mini-card input{background:#0b1f33;color:#eaf1ff;border:1px solid #2a3b52;border-radius:6px;padding:3px 5px;font-size:12px;width:160px}
.filters select,.filters input{background:#0f2238;color:#eaf1ff;border:1px solid #2a3b52;border-radius:6px;padding:4px 6px}
.btn{background:var(--primary);color:#fff;border:0;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px}
.btn.ghost{background:#eef2ff;color:#333;border:1px solid #ccc}
.grid{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);align-items:start;overflow:hidden}
.card{background:var(--card);color:var(--card-ink);border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);padding:8px;display:flex;flex-direction:column}
.section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.section-title h2{margin:0;font-size:14px;color:var(--card-ink)}
.section-title span.loc-label{font-size:13px;font-weight:600;color:#555;margin-left:6px}

/* Pods */
#podsCard{display:flex;flex-direction:column;justify-content:flex-start;flex:1;margin-bottom:18px;overflow:hidden;}
#specialRoles{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.pods-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.pod-card{border:1px solid #ddd;border-radius:8px;padding:10px;background:#f8fafc}
.pod-card h3{margin:0 0 6px;font-size:14px;font-weight:700;color:var(--primary)}
.pod-card label{font-size:12px;font-weight:600;display:block;margin-top:4px}
.pod-card input{width:100%;font-size:13px;padding:6px 8px;margin-top:2px;box-sizing:border-box}

/* Special Testing */
.testing-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
.testing-grid input{width:100%;padding:6px 8px;font-size:12px;border:1px solid #ccc;border-radius:6px}

/* Table blocks */
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #e0e6f4;padding:4px}th{background:#f6f8fc;text-align:left}
td input {
  width: calc(100% - 8px);
  box-sizing: border-box;
  padding: 4px 6px;
  font-size: 12px;
}

/* Notes/Staffing */
.notes-card textarea,.staffing-card textarea{resize:none;min-height:120px;max-height:120px}
</style>
</head>
<body>
<h1>Operations Dashboard</h1>
<div class="topbar">
  <div>
    <div id="now"></div>
    <label>PFC</label><input id="pfcInput"/>
  </div>
  <div class="mini-card">
    <div><label>Today's number of Patients</label><input id="todayCount" type="number"/></div>
  </div>
<div class="filters">
  <label>Location</label>
  <select id="locationSel"></select>
  <button id="clearLoc" class="btn ghost">Clear</button>
  <label>Date</label><input id="dateSel" type="date"/>
</div>

</div>

<div class="grid">
  <!-- LEFT: Pods & Assignments -->
  <div class="card" id="podsCard">
    <div class="section-title">
      <h2>Pods & Assignments <span id="podsLoc" class="loc-label"></span></h2>
      <div>
        <button id="savePods" class="btn">Save</button>
        <button id="clearPods" class="btn ghost">Clear</button>
      </div>
    </div>

    <!-- Opener & Z -->
    <div id="specialRoles">
      <div class="pod-card"><label>Opener</label><input id="opener" placeholder="Opener"></div>
      <div class="pod-card"><label>Z</label><input id="zField" placeholder="Z"></div>
    </div>

    <!-- Pods grid -->
    <div id="podsGrid" class="pods-grid"></div>
  </div>

  <!-- RIGHT: Testing, Issues, Maintenance, Notes -->
  <div class="right-grid">
    <!-- Special Testing -->
    <div class="card">
      <div class="section-title">
        <h2>General Special Testing</h2>
        <div>
          <button id="addTest" class="btn">Add</button>
          <button id="removeTest" class="btn ghost">Remove</button>
          <button id="saveTest" class="btn">Save</button>
        </div>
      </div>
      <div id="testingFields" class="testing-grid"></div>
    </div>

    <!-- Equipment Issues -->
    <div class="card">
      <div class="section-title"><h2>Equipment Issues</h2><button id="equipAddRow" class="btn">Add Item</button></div>
      <table id="equipTable">
        <thead><tr><th>Item</th><th>ETA</th><th>Status</th><th>Notes</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Building Maintenance -->
    <div class="card">
      <div class="section-title"><h2>Building Maintenance</h2><button id="buildAddRow" class="btn">Add Item</button></div>
      <table id="buildTable">
        <thead><tr><th>Item</th><th>ETA</th><th>Status</th><th>Notes</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Notes & Staffing -->
    <div class="card notes-card">
      <div class="section-title"><h2>Important Information/Overbooks</h2><button id="notesSave" class="btn">Save</button></div>
      <textarea id="notesBox"></textarea>
    </div>
    <div class="card staffing-card">
      <div class="section-title"><h2>Staffing Impacts</h2><button id="staffingSave" class="btn">Save</button></div>
      <textarea id="staffingBox"></textarea>
    </div>
  </div>
</div>
/* ===== Script 2 ===== */
<script>
/* ===== Debug toggle (Part 2) ===== */
const DEBUG_P2 = true;
const d2 = (...args) => { if (DEBUG_P2) console.log("[P2]", ...args); };

/* ------- State & store ------- */
const LOCS = ["Stillwater","Hudson","Woodbury","New Richmond","Lino Lakes"];
const KEY = "opsDashPodsCA";
const state = { location: "Stillwater", date: new Date().toISOString().slice(0,10) };
const store = {
  _data:null,
  load(){ 
    this._data=JSON.parse(localStorage.getItem(KEY)||"null")||{data:{}}; 
    d2("[STORE] Loaded data:", this._data);
  },
  save(){ 
    localStorage.setItem(KEY,JSON.stringify(this._data)); 
    d2("[STORE] Saved state for", state.location, state.date);
  },
  getDay(loc,date){
    if(!this._data.data[loc]) this._data.data[loc]={};
    if(!this._data.data[loc][date]) this._data.data[loc][date]={
      pfc:"", todayCount:"", opener:"", zField:"", orthoptist:"",
      pods:{}, tests:[{},{},{}], notes:"", staffing:""
    };
    return this._data.data[loc][date];
  },
  getEquip(loc){
    if(!this._data.data[loc]) this._data.data[loc]={};
    if(!this._data.data[loc].equipment) this._data.data[loc].equipment=[];
    return this._data.data[loc].equipment;
  },
  getBuild(loc){
    if(!this._data.data[loc]) this._data.data[loc]={};
    if(!this._data.data[loc].building) this._data.data[loc].building=[];
    return this._data.data[loc].building;
  }
}; 
store.load();

/* ------- Pods & Assignments ------- */
function renderPods(day){
  const allPods=[ 
    {id:"podA",label:"Pod A"},{id:"podB",label:"Pod B"},
    {id:"podC",label:"Pod C"},{id:"podD",label:"Pod D"},
    {id:"resident",label:"Resident"},{id:"contactLens",label:"Contact Lens"},
    {id:"float",label:"Float"},{id:"aScan",label:"A-Scan"},
    {id:"lasik",label:"LASIK"} 
  ];
  const hiddenByLoc={ 
    "Hudson":["resident","aScan","lasik"], 
    "Lino Lakes":["resident","aScan","lasik"], 
    "New Richmond":["resident","aScan","lasik"], 
    "Woodbury":["aScan","lasik"], 
    "Stillwater":[] 
  };
  const grid=document.getElementById("podsGrid");
  grid.innerHTML="";
  allPods.filter(p=>!hiddenByLoc[state.location].includes(p.id)).forEach(p=>{
    const d=day.pods[p.id]||{};
    const card=document.createElement("div");
    card.className="pod-card";
    if(p.id.startsWith("pod")){
      card.innerHTML=`<h3>${p.label}</h3>
        <label>Provider</label><input id="${p.id}prov" value="${d.prov||""}">
        <label>CA</label><input id="${p.id}ca" value="${d.ca||""}">
        <label>Technicians</label><input id="${p.id}techs" value="${d.techs||""}">`;
    } else {
      card.innerHTML=`<label>${p.label}</label><input id="${p.id}Val" placeholder="${p.label}" value="${d.value||""}">`;
    }
    grid.appendChild(card);
  });
  if(state.location==="Hudson" || state.location==="Woodbury"){
    const card=document.createElement("div");
    card.className="pod-card";
    card.innerHTML=`<label>Orthoptist</label><input id="orthoptist" placeholder="Orthoptist" value="${day.orthoptist||""}">`;
    grid.appendChild(card);
  }
  document.getElementById("opener").value=day.opener||"";
  document.getElementById("zField").value=day.zField||"";
}

/* Pods Save button */
document.getElementById("savePods").onclick=async ()=>{
  const d=store.getDay(state.location,state.date);
  ["podA","podB","podC","podD"].forEach(id=>{
    const prov=document.getElementById(id+"prov");
    if(prov){
      d.pods[id]={ 
        prov: prov.value, 
        ca: document.getElementById(id+"ca").value, 
        techs: document.getElementById(id+"techs").value 
      };
    }
  });
  ["resident","contactLens","float","aScan","lasik"].forEach(id=>{
    const el=document.getElementById(id+"Val");
    if(el){ d.pods[id]={value:el.value}; }
  });
  d.opener=document.getElementById("opener").value; 
  d.zField=document.getElementById("zField").value;
  if(state.location==="Hudson" || state.location==="Woodbury"){ 
    const ortho=document.getElementById("orthoptist"); 
    if(ortho) d.orthoptist=ortho.value; 
  } else { d.orthoptist=""; }
  store.save();
  try { 
    d2("UI: savePods -> upsert");
    await savePodsToSharePoint(d); 
    // Reload to confirm latest
    await loadPodsFromSharePoint();
  } catch(err) { console.error("[SP] Save pods failed:", err); }
};
document.getElementById("clearPods").onclick=()=>{
  const d=store.getDay(state.location,state.date);
  d.pods={}; d.opener=""; d.zField=""; d.orthoptist="";
  store.save(); renderPods(d); fitPodsCard();
};

/* ===== Pods Loader (from SharePoint) ===== */
async function loadPodsFromSharePoint() {
  try {
    const token = await getToken();
    const loc = state.location;
    const day = state.date;
    const filter = encodeURIComponent(`fields/Location eq '${loc}' and fields/Date eq '${day}'`);
    const url =
      `https://graph.microsoft.com/v1.0/sites/${siteId}` +
      `/lists/${podsListId}/items?$expand=fields($select=Location,Date,DataJson)&$filter=${filter}&$top=1`;
    d2("Pods: load URL", url);

    const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
    if (!res.ok) { console.error("[SP] Pods load failed:", res.status, await res.text()); return; }
    const json = await res.json();
    if (!json.value || json.value.length === 0) { d2("Pods: no item for", loc, day); return; }

    const fields = json.value[0].fields || {};
    let parsed = {};
    try { parsed = fields.DataJson ? JSON.parse(fields.DataJson) : {}; }
    catch (e) { console.warn("[SP] Pods DataJson parse error:", e); parsed = {}; }

    const d = store.getDay(state.location, state.date);
    d.pods = parsed;
    store.save();
    renderPods(d);
    d2("Pods: loaded OK", loc, day, parsed);
  } catch (err) {
    console.error("[SP] Pods load threw error:", err);
  }
}

/* ------- Special Testing ------- */
function renderTests(d){ 
  const cont=document.getElementById("testingFields"); 
  cont.innerHTML=""; 
  const arr=d.tests && d.tests.length ? d.tests : [{},{},{}]; 
  arr.forEach((t,i)=>{ 
    const input=document.createElement("input"); 
    input.placeholder="Test "+(i+1); 
    input.value=t.name||""; 
    input.id="test"+i; 
    cont.appendChild(input); 
  }); 
}
document.getElementById("saveTest").onclick=async ()=>{ 
  const d=store.getDay(state.location,state.date); 
  d.tests=[...document.querySelectorAll("#testingFields input")].map(x=>({name:x.value}));
  store.save(); 
  d2("UI: saveTest -> upsert");
  await saveTestsToSharePoint(d);
  await loadTestsFromSharePoint();
};
document.getElementById("addTest").onclick=()=>{ 
  const d=store.getDay(state.location,state.date); 
  d.tests.push({}); 
  store.save(); renderTests(d); 
};
document.getElementById("removeTest").onclick=()=>{ 
  const d=store.getDay(state.location,state.date); 
  if(d.tests.length > 1) d.tests.pop(); 
  store.save(); renderTests(d); 
};

/* ===== Special Testing Loader ===== */
async function loadTestsFromSharePoint() {
  try {
    const token = await getToken();
    const loc = state.location;
    const day = state.date;
    const filter = encodeURIComponent(`fields/Location eq '${loc}' and fields/Date eq '${day}'`);
    const url =
      `https://graph.microsoft.com/v1.0/sites/${siteId}` +
      `/lists/${testsListId}/items?$expand=fields($select=Location,Date,DataJson)&$filter=${filter}&$top=1`;
    d2("Tests: load URL", url);

    const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
    if (!res.ok) { console.error("[SP] Tests load failed:", res.status, await res.text()); return; }
    const json = await res.json();
    if (!json.value || json.value.length === 0) { d2("Tests: no item for", loc, day); return; }

    const fields = json.value[0].fields || {};
    let arr = [];
    try { arr = fields.DataJson ? JSON.parse(fields.DataJson) : []; }
    catch (e) { console.warn("[SP] Tests DataJson parse error:", e); arr = []; }

    const d = store.getDay(state.location, state.date);
    d.tests = Array.isArray(arr) ? arr : [];
    store.save();
    renderTests(d);
    d2("Tests: loaded OK", loc, day, d.tests.length);
  } catch (err) {
    console.error("[SP] Tests load threw error:", err);
  }
}

/* ------- Equipment Issues ------- */
function equipRowHtml(r={},isNew=false){ 
  return `<tr>
    <td><input value="${r.item||""}" data-f="item"></td>
    <td><input value="${r.eta||""}" data-f="eta"></td>
    <td><input value="${r.status||""}" data-f="status"></td>
    <td><input value="${r.notes||""}" data-f="notes"></td>
    <td>${isNew
      ? '<button class="btn saveRow">Save</button><button class="btn ghost cancelRow">Cancel</button>'
      : '<button class="btn ghost deleteRow">Delete</button>'}
    </td>
  </tr>`;
}
function renderEquipTable(equip){ 
  document.querySelector("#equipTable tbody").innerHTML=(equip||[]).map(r=>equipRowHtml(r,false)).join(""); 
}
document.getElementById("equipAddRow").onclick=()=>{ 
  document.querySelector("#equipTable tbody").insertAdjacentHTML("beforeend", equipRowHtml({},true)); 
};
document.querySelector("#equipTable tbody").addEventListener("click",async e=>{
  const equip=store.getEquip(state.location);
  if(e.target.classList.contains("saveRow")){
    const tr=e.target.closest("tr");
    const row={}; 
    [...tr.querySelectorAll("input")].forEach(i=>row[i.dataset.f]=i.value);
    equip.push(row); 
    store.save(); 
    renderEquipTable(equip);
    await saveEquipToSharePoint({equipment:equip});
  }
  if(e.target.classList.contains("cancelRow")) e.target.closest("tr").remove();
  if(e.target.classList.contains("deleteRow")){
    const tr=e.target.closest("tr");
    const idx=[...tr.parentNode.children].indexOf(tr);
    equip.splice(idx,1); 
    store.save(); 
    renderEquipTable(equip);
    await saveEquipToSharePoint({equipment:equip});
  }
});

/* ------- Building Maintenance ------- */
function buildRowHtml(r={},isNew=false){ 
  return `<tr>
    <td><input value="${r.item||""}" data-f="item"></td>
    <td><input value="${r.eta||""}" data-f="eta"></td>
    <td><input value="${r.status||""}" data-f="status"></td>
    <td><input value="${r.notes||""}" data-f="notes"></td>
    <td>${isNew
      ? '<button class="btn saveRow">Save</button><button class="btn ghost cancelRow">Cancel</button>'
      : '<button class="btn ghost deleteRow">Delete</button>'}
    </td>
  </tr>`;
}
function renderBuildTable(build){ 
  document.querySelector("#buildTable tbody").innerHTML=(build||[]).map(r=>buildRowHtml(r,false)).join(""); 
}
document.getElementById("buildAddRow").onclick=()=>{ 
  document.querySelector("#buildTable tbody").insertAdjacentHTML("beforeend", buildRowHtml({},true)); 
};
document.querySelector("#buildTable tbody").addEventListener("click",async e=>{
  const build=store.getBuild(state.location);
  if(e.target.classList.contains("saveRow")){
    const tr=e.target.closest("tr");
    const row={}; 
    [...tr.querySelectorAll("input")].forEach(i=>row[i.dataset.f]=i.value);
    build.push(row); 
    store.save(); 
    renderBuildTable(build);
    await saveBuildToSharePoint({building:build});
  }
  if(e.target.classList.contains("cancelRow")) e.target.closest("tr").remove();
  if(e.target.classList.contains("deleteRow")){
    const tr=e.target.closest("tr");
    const idx=[...tr.parentNode.children].indexOf(tr);
    build.splice(idx,1); 
    store.save(); 
    renderBuildTable(build);
    await saveBuildToSharePoint({building:build});
  }
});

/* ------- Notes / Staffing (UI handlers call SP upsert) ------- */
document.getElementById("notesSave").onclick=async ()=>{ 
  const d=store.getDay(state.location,state.date); 
  d.notes=document.getElementById("notesBox").value; 
  store.save();
  d2("UI: saveNotes -> upsert");
  await saveNotesToSharePoint(d);
  await loadNotesFromSharePoint();
};
document.getElementById("staffingSave").onclick=async ()=>{ 
  const d=store.getDay(state.location,state.date); 
  d.staffing=document.getElementById("staffingBox").value; 
  store.save(); 
  d2("UI: saveStaffing -> upsert");
  await saveStaffingToSharePoint(d);
  await loadStaffingFromSharePoint();
};

/* ===== Notes Loader ===== */
async function loadNotesFromSharePoint() {
  try {
    const token = await getToken();
    const loc = state.location;
    const day = state.date;
    const filter = encodeURIComponent(`fields/Location eq '${loc}' and fields/Date eq '${day}'`);
    const url =
      `https://graph.microsoft.com/v1.0/sites/${siteId}` +
      `/lists/${notesListId}/items?$expand=fields($select=Location,Date,DataJson)&$filter=${filter}&$top=1`;
    d2("Notes: load URL", url);

    const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
    if (!res.ok) { console.error("[SP] Notes load failed:", res.status, await res.text()); return; }
    const json = await res.json();
    if (!json.value || json.value.length === 0) { d2("Notes: no item for", loc, day); return; }

    const fields = json.value[0].fields || {};
    let val = "";
    try { val = fields.DataJson ? JSON.parse(fields.DataJson) : ""; }
    catch (e) { console.warn("[SP] Notes DataJson parse error:", e); val = ""; }

    const d = store.getDay(state.location, state.date);
    d.notes = typeof val === "string" ? val : "";
    store.save();
    document.getElementById("notesBox").value = d.notes;
    d2("Notes: loaded OK", loc, day, (d.notes||"").length);
  } catch (err) {
    console.error("[SP] Notes load threw error:", err);
  }
}

/* ===== Staffing Loader ===== */
async function loadStaffingFromSharePoint() {
  try {
    const token = await getToken();
    const loc = state.location;
    const day = state.date;
    const filter = encodeURIComponent(`fields/Location eq '${loc}' and fields/Date eq '${day}'`);
    const url =
      `https://graph.microsoft.com/v1.0/sites/${siteId}` +
      `/lists/${staffingListId}/items?$expand=fields($select=Location,Date,DataJson)&$filter=${filter}&$top=1`;
    d2("Staffing: load URL", url);

    const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
    if (!res.ok) { console.error("[SP] Staffing load failed:", res.status, await res.text()); return; }
    const json = await res.json();
    if (!json.value || json.value.length === 0) { d2("Staffing: no item for", loc, day); return; }

    const fields = json.value[0].fields || {};
    let val = "";
    try { val = fields.DataJson ? JSON.parse(fields.DataJson) : ""; }
    catch (e) { console.warn("[SP] Staffing DataJson parse error:", e); val = ""; }

    const d = store.getDay(state.location, state.date);
    d.staffing = typeof val === "string" ? val : "";
    store.save();
    document.getElementById("staffingBox").value = d.staffing;
    d2("Staffing: loaded OK", loc, day, (d.staffing||"").length);
  } catch (err) {
    console.error("[SP] Staffing load threw error:", err);
  }
}
/* ===== Load Equipment (no Date) ===== */
async function loadEquipFromSharePoint() {
  try {
    const token = await getToken();
    const loc = state.location;

    const filter = encodeURIComponent(`fields/Location eq '${loc}'`);
    const url =
      `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${equipListId}/items?` +
      `$expand=fields($select=Location,DataJson)&$filter=${filter}&$top=1`;
    d2("Equip: load URL", url);

    const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
    if (!res.ok) {
      console.error("[SP] Equip load failed:", res.status, await res.text());
      return;
    }

    const json = await res.json();
    if (json.value && json.value.length) {
      const fields = json.value[0].fields || {};
      let arr = [];
      try { arr = fields.DataJson ? JSON.parse(fields.DataJson) : []; }
      catch (e) { console.warn("[SP] Equip DataJson parse error:", e); arr = []; }

      const equip = store.getEquip(loc);
      equip.length = 0; // clear existing
      arr.forEach(r => equip.push(r));
      store.save();

      renderEquipTable(equip);
      d2("Equip: loaded OK", loc, equip.length);
    } else {
      d2("Equip: no entry found for", loc);
      const equip = store.getEquip(loc);
      equip.length = 0;
      store.save();
      renderEquipTable(equip);
    }
  } catch (e) {
    console.error("[SP] Equip load threw:", e);
  }
}

/* ===== Load Building (no Date) ===== */
async function loadBuildFromSharePoint() {
  try {
    const token = await getToken();
    const loc = state.location;

    const filter = encodeURIComponent(`fields/Location eq '${loc}'`);
    const url =
      `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${buildListId}/items?` +
      `$expand=fields($select=Location,DataJson)&$filter=${filter}&$top=1`;
    d2("Build: load URL", url);

    const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
    if (!res.ok) {
      console.error("[SP] Build load failed:", res.status, await res.text());
      return;
    }

    const json = await res.json();
    if (json.value && json.value.length) {
      const fields = json.value[0].fields || {};
      let arr = [];
      try { arr = fields.DataJson ? JSON.parse(fields.DataJson) : []; }
      catch (e) { console.warn("[SP] Build DataJson parse error:", e); arr = []; }

      const build = store.getBuild(loc);
      build.length = 0; // clear existing
      arr.forEach(r => build.push(r));
      store.save();

      renderBuildTable(build);
      d2("Build: loaded OK", loc, build.length);
    } else {
      d2("Build: no entry found for", loc);
      const build = store.getBuild(loc);
      build.length = 0;
      store.save();
      renderBuildTable(build);
    }
  } catch (e) {
    console.error("[SP] Build load threw:", e);
  }
}


/* ------- Topbar & render ------- */
function renderTopbar(d){
  const sel=document.getElementById("locationSel");
  sel.innerHTML=LOCS.map(l=>`<option ${l===state.location?"selected":""}>${l}</option>`).join("");
  document.getElementById("dateSel").value=state.date;
  document.getElementById("pfcInput").value=d.pfc||"";
  document.getElementById("todayCount").value=d.todayCount||"";
  document.getElementById("podsLoc").textContent=`(${state.location})`;
}
document.getElementById("locationSel").onchange=async e=>{
  state.location=e.target.value;
  renderAll();
  // load server state for new location/date
  await Promise.all([
    loadPodsFromSharePoint(),
    loadTestsFromSharePoint(),
    loadNotesFromSharePoint(),
    loadStaffingFromSharePoint(),
    loadEquipFromSharePoint(),
    loadBuildFromSharePoint()
  ]);
};
document.getElementById("dateSel").onchange=async e=>{
  state.date=e.target.value;
  renderAll();
  await Promise.all([
    loadPodsFromSharePoint(),
    loadTestsFromSharePoint(),
    loadNotesFromSharePoint(),
    loadStaffingFromSharePoint()
  ]);
};

/* Clear button: clears only day-scoped sections (not Equip/Build) */
document.getElementById("clearLoc").onclick = () => {
  const d = store.getDay(state.location, state.date);
  d.pods = {};
  d.opener = "";
  d.zField = "";
  d.orthoptist = "";
  d.tests = [{},{},{}];
  d.notes = "";
  d.staffing = "";
  d.pfc = "";
  d.todayCount = "";
  store.save();
  renderAll();
};

/* PFC / Patient Count auto-save */
document.getElementById("pfcInput").onchange=async ()=>{
  const d=store.getDay(state.location,state.date);
  d.pfc=document.getElementById("pfcInput").value; 
  store.save();
  await savePfcToSharePoint(d);
};
document.getElementById("todayCount").onchange=async ()=>{
  const d=store.getDay(state.location,state.date);
  d.todayCount=document.getElementById("todayCount").value; 
  store.save();
  await savePatientCountToSharePoint(d);
};

/* ------- Auto-fit Pods ------- */
function fitPodsCard(){
  const podsCard=document.getElementById('podsCard');
  if(!podsCard) return;
  const h1=document.querySelector('h1');
  const topbar=document.querySelector('.topbar');
  const bcs=getComputedStyle(document.body);
  const bodyPad=parseInt(bcs.paddingTop||'12')+parseInt(bcs.paddingBottom||'12');
  const headerH=(h1?h1.getBoundingClientRect().height:0)+(topbar?topbar.getBoundingClientRect().height:0);
  const blueStrip=10;
  const available=window.innerHeight - headerH - bodyPad - blueStrip;
  podsCard.style.maxHeight = available + 'px';
}

/* ------- Permissions check ------- */
const allowedEditors=["tmonigold@associatedeyecare.com","sgeary@associatedeyecare.com","jlark@associatedeyecare.com"];
function applyPermissions(){
  const account = msalInstance.getAllAccounts()[0];
  const email = account ? account.username.toLowerCase() : "";
  const canEdit = allowedEditors.includes(email);
  d2("Permissions: email/canEdit", email, canEdit);
  document.getElementById("equipAddRow").style.display=canEdit?"inline-block":"none";
  document.getElementById("buildAddRow").style.display=canEdit?"inline-block":"none";
}

/* ===== Main render ===== */
function renderAll(){
  const d = store.getDay(state.location, state.date);
  const equip = store.getEquip(state.location);
  const build = store.getBuild(state.location);

  renderTopbar(d);
  renderPods(d);
  renderTests(d);
  renderEquipTable(equip);
  renderBuildTable(build);

  document.getElementById("notesBox").value = d.notes;
  document.getElementById("staffingBox").value = d.staffing;

  fitPodsCard();
  applyPermissions();
}

/* ===== Window events ===== */
window.addEventListener('resize', fitPodsCard);
setInterval(() => {
  const nowEl = document.getElementById("now");
  if (nowEl) nowEl.textContent = new Date().toLocaleString();
}, 1000);

/* ===== Force login on page load, then initial loads ===== */
document.addEventListener("DOMContentLoaded", async () => {
  try {
    d2("DOMContentLoaded: ensureLogin()");
    await ensureLogin();
    renderAll();
  d2("Initial loads: pods/tests/notes/staffing/equip/build");
  await Promise.all([
    loadPodsFromSharePoint(),
    loadTestsFromSharePoint(),
    loadNotesFromSharePoint(),
    loadStaffingFromSharePoint(),
    loadEquipFromSharePoint(),
    loadBuildFromSharePoint()
  ]);
  d2("Initial loads complete");

  } catch (err) {
    console.error("[MSAL] Login failed on page load:", err);
    const body = document.querySelector("body");
    if (body) {
      body.innerHTML = `
        <div style="color:white; background:#0d1b2a; height:100vh; display:flex; align-items:center; justify-content:center; text-align:center; flex-direction:column;">
          <h2>Login Required</h2>
          <p>Please refresh the page and sign in with your AEC account to use the dashboard.</p>
        </div>
      `;
    }
  }
});
</script>
</body>
</html>





































